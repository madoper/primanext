```markdown
# Технический проект MVP ПримаNEXT

## 1. Введение

**ПримаNEXT (MVP)** — веб‑платформа для поиска и просмотра карточек российских компаний на основе собственного датасета (~10 000 компаний), с разделением прав доступа между анонимными пользователями/поисковыми ботами и зарегистрированными пользователями. [file:1]  
Основная задача MVP — обеспечить быстрый поиск по ИНН/названию, просмотр публичной и полной карточки компании и генерацию простого PDF‑отчёта, соблюдая целевую производительность p95 < 500 мс для ключевых API. [file:1]  

---

## 2. Объём и сценарии MVP

### 2.1 Пользовательские роли

- Анонимный пользователь / поисковый бот:
  - Может выполнять поиск компаний.
  - Может просматривать «публичную» карточку компании.
  - Не видит чувствительные поля (часть полей закрыта). [file:1]  

- Зарегистрированный пользователь (через Keycloak):
  - Видит полную карточку компании (все поля).
  - Может скачивать простой PDF‑отчёт по компании. [file:1]  

### 2.2 Основные сценарии

- Поиск компании:
  - Ввод ИНН или названия.
  - Отображение списка результатов. [file:1]  

- Просмотр карточки:
  - Публичная карточка по URL `/company/{inn}` с ограниченным набором полей. [file:1]  
  - Полная карточка для залогиненного пользователя через защищённый API. [file:1]  

- Генерация отчёта:
  - Зарегистрированный пользователь нажимает «Скачать отчёт (PDF)».
  - Backend синхронно генерирует простой отчёт и отдаёт файл. [file:1]  

---

## 3. Архитектура MVP

### 3.1 Общая схема

- **Frontend**: Vue 3 + TypeScript (SPA), общается с backend по REST API, поддерживает:
  - Страницу поиска.
  - Страницу карточки компании (`/company/{inn}`).
  - Кнопку скачивания PDF‑отчёта для авторизованных. [file:1]  

- **Backend (монолит)**: ASP.NET Core (.NET 8) единый Web API:
  - Модули: Public, Companies, Search, Reports, Auth‑proxy. [file:1]  
  - Взаимодействие с Keycloak по OIDC/OAuth2 (Bearer‑токен в запросах к `/api/*`). [file:1]  

- **Хранилище данных**:
  - MongoDB или PostgreSQL как основное хранилище сущности Company (по уже описанной доменной модели). [file:1]  
  - Elasticsearch/OpenSearch c индексом `companies` для полнотекстового/фильтрационного поиска. [file:1]  

- **Инфраструктура**:
  - Docker Compose для локальной и простой продакшн‑сборки: `api`, `frontend`, `db`, `elasticsearch`, `keycloak`. [file:1]  
  - Минимальный мониторинг: health‑checks, базовые метрики времени ответа. [file:1]  

### 3.2 Данные и миграции

- Исходный датасет 10 000 компаний загружается в БД через отдельный импорт‑скрипт (консольное приложение или скрипт миграции). [file:1]  
- После загрузки выполняется первичное индексирование в Elasticsearch (bulk‑индекс `companies`), используя уже заданные настройки анализаторов и маппингов под русский язык. [file:1]  

---

## 4. Схемы данных (упрощённо)

### 4.1 Company (полная модель в БД)

Ключевые поля (по уже существующей доменной модели):

- `id` — идентификатор (UUID/ObjectId). [file:1]  
- `inn` (string, 10/12 цифр) — валидируется по алгоритму ИНН. [file:1]  
- `ogrn` (string, 13/15 цифр) — валидируется по алгоритму ОГРН. [file:1]  
- `name`:
  - `fullName`
  - `shortName` [file:1]  
- `status` — `active | liquidation | liquidated | bankruptcy | reorganization`. [file:1]  
- `address` — регион, город, форматированный адрес. [file:1]  
- `okved` — основной ОКВЭД (код, наименование), плюс дополнительные при необходимости. [file:1]  
- Доп. поля для полной карточки: учредители, менеджмент, финансы, риск‑оценка, история и т.п. (используются только в приватном API). [file:1]  

### 4.2 CompanyPublicDTO

Используется во всех публичных ответах:

- `inn`
- `ogrn`
- `name.fullName`, `name.shortName`
- `status`
- `region` (код региона)
- `okved.code`, `okved.name` [file:1]  

---

## 5. API: публичный слой

Все эндпоинты доступны без авторизации и не возвращают чувствительные данные. [file:1]  

### 5.1 GET `/public/companies/{inn}`

**Назначение:** вернуть публичную карточку по ИНН (для ботов и анонимов). [file:1]  

- Параметры:
  - `inn`: строка 10 или 12 цифр, проверяется по алгоритму INN. [file:1]  

- Ответ 200:
  - Тело: `{ success, data: CompanyPublicDTO, meta }`. [file:1]  

- Ошибки:
  - 400 — невалидный формат ИНН.
  - 404 — компания не найдена. [file:1]  

- Производительность:
  - Цель: p95 < 500 мс (с учётом кэширования и индексов). [file:1]  

### 5.2 GET `/public/search`

**Назначение:** поиск компаний по ИНН/названию с публичным набором полей. [file:1]  

- Параметры:
  - `q` — строка ≥ 3 символов (ИНН или часть названия).
  - `page` (int, ≥1, по умолчанию 1).
  - `pageSize` (int, 1–50, по умолчанию 20). [file:1]  

- Ответ 200:
  - `data`: массив `CompanyPublicDTO`.
  - `pagination`: `page, pageSize, totalPages, totalItems`. [file:1]  

- Поиск реализуется через Elasticsearch с использованием уже описанного `SearchService` и настроек индекса `companies`. [file:1]  

### 5.3 GET `/robots.txt`

**Назначение:** динамический `robots.txt`. [file:1]  

- Пример содержимого:
  - `User-agent: *`
  - `Allow: /company/`
  - `Disallow: /api/`
  - `Sitemap: https://<host>/sitemap-index.xml` [file:1]  

### 5.4 GET `/sitemap-index.xml`, `/sitemap-{n}.xml`

**Назначение:** динамические sitemap для 10 000 карточек. [file:1]  

- `sitemap-index.xml` содержит ссылки на батчи `sitemap-1.xml`, …, `sitemap-10.xml` (по 1000 URL). [file:1]  
- Каждый `sitemap-{n}.xml` формируется из БД/ES:
  - URL: `https://<host>/company/{inn}`
  - `lastmod` по полю `UpdatedAt`. [file:1]  

### 5.5 GET `/health`

Простой health‑check сервиса (проверка подключения к БД и Elasticsearch). [file:1]  

---

## 6. API: приватный слой (под Keycloak)

Все нижеописанные эндпоинты требуют валидного Bearer‑токена от Keycloak. [file:1]  

### 6.1 GET `/api/companies/{inn}`

**Назначение:** вернуть полную карточку компании для зарегистрированного пользователя. [file:1]  

- Параметры и ошибки — аналогично `/public/companies/{inn}`. [file:1]  
- Ответ 200: полная `Company`‑модель (по доменной схеме, включая дополнительные поля). [file:1]  

### 6.2 GET `/api/search`

**Назначение:** расширенный поиск по компаниям для авторизованных пользователей. [file:1]  

- Параметры (подмножество уже описанной спецификации Search API):
  - `q` — строка.
  - `region` — код региона.
  - `entityType` — тип организации.
  - `status` — статус компании.
  - `page`, `pageSize`. [file:1]  

- Ответ 200: массив облегчённых «поисковых DTO» (inn, name, status, region, riskScore, основные финансы) + `pagination`. [file:1]  

### 6.3 POST `/api/reports/company/{inn}`

**Назначение:** синхронная генерация простого PDF‑отчёта. [file:1]  

- Тело запроса (MVP‑вариант):
  ```
  {
    "reportType": "standard",
    "includeFinancials": true,
    "includeFounders": true
  }
  ```  

- Логика:
  - Загрузить полную `Company` по ИНН.
  - Сформировать модель отчёта (компания, базовые финансы, учредители).
  - Сгенерировать PDF через QuestPDF (или аналог, уже предложенный в полном проекте). [file:1]  
  - Сохранить PDF на диск/в файловое хранилище и записать метаданные `Report` в БД. [file:1]  

- Ответ 201:
  ```
  {
    "success": true,
    "data": {
      "reportId": "uuid",
      "status": "completed",
      "downloadUrl": "https://<host>/api/reports/{reportId}/download"
    }
  }
  ```  

### 6.4 GET `/api/reports/{reportId}/download`

**Назначение:** скачивание ранее сгенерированного PDF‑отчёта. [file:1]  

- Ответ 200: `Content-Type: application/pdf`, тело — PDF.  
- 404 — отчёт не найден или недоступен этому пользователю. [file:1]  

### 6.5 GET `/api/me`

**Назначение:** вернуть информацию о текущем пользователе по токену Keycloak. [file:1]  

- Поля: `id`, `email`, `name`, `role`. [file:1]  
- Используется фронтендом для определения, нужно ли показывать полную карточку и кнопку скачивания отчёта. [file:1]  

---

## 7. Нефункциональные требования

### 7.1 Производительность

- Цель: p95 < 500 мс для:
  - `GET /public/companies/{inn}`
  - `GET /public/search`
  - `GET /api/companies/{inn}` [file:1]  

- Меры:
  - Использование индексов в БД и оптимизированных запросов к Elasticsearch (как описано в разделе Search Performance). [file:1]  
  - Кэширование публичных карточек по `inn` (in‑memory или Redis) на 10–30 минут. [file:1]  
  - HTTP‑кэширование: `ETag`, `Cache-Control` для публичных ответов, как уже описано в API performance‑разделе. [file:1]  

### 7.2 Безопасность

- Keycloak — единственный IdP; backend доверяет его токенам, сам не хранит пароли. [file:1]  
- Публичные эндпоинты гарантированно не содержат закрытых полей; все расширенные данные доступны только через `/api/*` под авторизацией. [file:1]  

---

## 8. План реализации MVP

### 8.1 Этапы

- Неделя 1–2:
  - Настройка Docker Compose (api, frontend, db, elasticsearch, keycloak).
  - Импорт датасета 10 000 компаний в БД.
  - Первичное индексирование в Elasticsearch. [file:1]  

- Неделя 3–4:
  - Реализация модулей Companies и Search (публичный и приватный API).
  - Реализация Reports (простые PDF‑отчёты).
  - Базовый frontend: поиск, список, карточка, скачивание отчёта. [file:1]  

- Неделя 5–6:
  - Реализация `/robots.txt` и sitemap.
  - Введение кэширования и базовых метрик производительности.
  - Написание unit‑ и простых API‑тестов, отладка до достижения p95<500 мс на целевых сценариях. [file:1]  

---

## 9. Итог

Данный документ фиксирует минимальный, но целостный технический проект MVP ПримаNEXT: один монолитный backend c ограниченным набором API, фронтенд на Vue 3, поиск и карточка компании на собственном датасете, простой PDF‑отчёт, SEO‑дружественные публичные страницы и чёткое разделение публичных и приватных данных. [file:1]  
Все расширенные функции (мониторинг, графы, карты, интеграции, тарифы, LLM) выносятся в последующие фазы, не усложняя MVP‑архитектуру. [file:1]  
```

[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/144818146/c85bea00-feaa-4716-96aa-06e3ffd0ce12/primanext_full_chat_contents-2.md)
